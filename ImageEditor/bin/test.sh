#!/bin/bash

file=ImageEditor.java

if [ ! -f "$file" ]; then
    echo -e "Error: File '$file' not found.\nTest failed."
    exit 1
fi

num_right=0
total=0
line="________________________________________________________________________"
compiler=
interpreter=
language=
if [ "${file##*.}" = "py" ]; then
    if [ ! -z "$PYTHON_PATH" ]; then
        interpreter=$(which python.exe)
    else
        interpreter=$(which python3.2)
    fi
    command="$interpreter $file"
    echo -e "Testing $file\n"
elif [ "${file##*.}" = "java" ]; then
    language="java"
    command="java ${file%.java}"
    echo -n "Compiling $file..."
    javac $file
    echo -e "done\n"
fi

run_test_args() {
    (( ++total ))
    echo -n "Running test $total..."
    expected=$2
    received=$( $command $1 2>&1 | tr -d '\r' )
    if [ "$expected" = "$received" ]; then
        echo "success"
        (( ++num_right ))
    else
        echo -e "failure\n\nExpected$line\n$expected\nReceived$line\n$received\n"
    fi
}

(cat << EOF
EOF
) > blank.txt

(cat << EOF
-------------------------------
-----------OOOOO---------------
---------OO-----OO-------------
-------OO---------OO-----------
-------OO---------OO-----------
-------OO---------OO-----------
---------OO-----OO-------------
-----------OOOOO---------------
-----------------------########
-----------------------#-------
-----------------------#-------
EOF
) > image1.txt

(cat << EOF
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--------##############----------------------------------------------------------
-------#              #---------------------------------------------------------
------#                #--------------------------------------------------------
-----#                  ###################################---------------------
-----#                                                     #--------------------
-----#                  ################# ### ### ### ###  #--------------------
------#                #----------------###-###-###-###-###---------------------
-------#              #---------------------------------------------------------
--------##############----------------------------------------------------------
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
EOF
) > image2.txt

run_test_args "" "Usage: java ImageEditor <ASCII image file> <f|b> <row> <column> <new char>"
run_test_args "notfound.txt f 0 0 +" "Error: File 'notfound.txt' not found."
run_test_args "blank.txt f 0 0 +" "Error: 'blank.txt' is empty."
run_test_args "image1.txt x 0 0 +" "Error: Invalid option 'x'. Expected 'f' or 'b'."
run_test_args "image1.txt f x 0 +" "Error: Invalid row value 'x'."
run_test_args "image1.txt f 0 y +" "Error: Invalid column value 'y'."
run_test_args "image1.txt f -1 -1 +" "Error: No pixel at (-1, -1)."
run_test_args "image1.txt f 0 31 +" "Error: No pixel at (0, 31)."
run_test_args "image1.txt f 0 0 ++" "Error: Invalid new character '++'."
run_test_args "image1.txt f 0 0 ." "Original image:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"After flood fill:"$'\n'"..............................."$'\n'"...........OOOOO..............."$'\n'".........OO-----OO............."$'\n'".......OO---------OO..........."$'\n'".......OO---------OO..........."$'\n'".......OO---------OO..........."$'\n'".........OO-----OO............."$'\n'"...........OOOOO..............."$'\n'".......................########"$'\n'".......................#-------"$'\n'".......................#-------"$'\n'$'\n'"250 pixels changed."
run_test_args "image1.txt b 7 15 8" "Original image:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"After replacing border:"$'\n'"-------------------------------"$'\n'"-----------88888---------------"$'\n'"---------88-----88-------------"$'\n'"-------88---------88-----------"$'\n'"-------88---------88-----------"$'\n'"-------88---------88-----------"$'\n'"---------88-----88-------------"$'\n'"-----------88888---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"30 pixels changed."
run_test_args "image1.txt f 6 15 =" "Original image:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"After flood fill:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO=====OO-------------"$'\n'"-------OO=========OO-----------"$'\n'"-------OO=========OO-----------"$'\n'"-------OO=========OO-----------"$'\n'"---------OO=====OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"37 pixels changed."
run_test_args "image1.txt f 7 15 =" "Original image:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"After flood fill:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------=====---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"5 pixels changed."
run_test_args "image1.txt b 8 30 ^" "Original image:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------########"$'\n'"-----------------------#-------"$'\n'"-----------------------#-------"$'\n'$'\n'"After replacing border:"$'\n'"-------------------------------"$'\n'"-----------OOOOO---------------"$'\n'"---------OO-----OO-------------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"-------OO---------OO-----------"$'\n'"---------OO-----OO-------------"$'\n'"-----------OOOOO---------------"$'\n'"-----------------------^^^^^^^^"$'\n'"-----------------------^-------"$'\n'"-----------------------^-------"$'\n'$'\n'"10 pixels changed."
run_test_args "image2.txt b 0 0 ." "Original image:"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"------#                #--------------------------------------------------------"$'\n'"-----#                  ###################################---------------------"$'\n'"-----#                                                     #--------------------"$'\n'"-----#                  ################# ### ### ### ###  #--------------------"$'\n'"------#                #----------------###-###-###-###-###---------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'$'\n'"After replacing border:"$'\n'"................................................................................"$'\n'"................................................................................"$'\n'"........##############.........................................................."$'\n'".......#              #........................................................."$'\n'"......#                #........................................................"$'\n'".....#                  ###################################....................."$'\n'".....#                                                     #...................."$'\n'".....#                  ################# ### ### ### ###  #...................."$'\n'"......#                #................###.###.###.###.###....................."$'\n'".......#              #........................................................."$'\n'"........##############.........................................................."$'\n'"................................................................................"$'\n'"................................................................................"$'\n'$'\n'"765 pixels changed."
run_test_args "image2.txt b 2 8 @" "Original image:"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"------#                #--------------------------------------------------------"$'\n'"-----#                  ###################################---------------------"$'\n'"-----#                                                     #--------------------"$'\n'"-----#                  ################# ### ### ### ###  #--------------------"$'\n'"------#                #----------------###-###-###-###-###---------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'$'\n'"After replacing border:"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------@@@@@@@@@@@@@@----------------------------------------------------------"$'\n'"-------@              @---------------------------------------------------------"$'\n'"------@                @--------------------------------------------------------"$'\n'"-----@                  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@---------------------"$'\n'"-----@                                                     @--------------------"$'\n'"-----@                  @@@@@@@@@@@@@@@@@ @@@ @@@ @@@ @@@  @--------------------"$'\n'"------@                @----------------@@@-@@@-@@@-@@@-@@@---------------------"$'\n'"-------@              @---------------------------------------------------------"$'\n'"--------@@@@@@@@@@@@@@----------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'$'\n'"120 pixels changed."
run_test_args "image2.txt f 3 8 +" "Original image:"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"------#                #--------------------------------------------------------"$'\n'"-----#                  ###################################---------------------"$'\n'"-----#                                                     #--------------------"$'\n'"-----#                  ################# ### ### ### ###  #--------------------"$'\n'"------#                #----------------###-###-###-###-###---------------------"$'\n'"-------#              #---------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'$'\n'"After flood fill:"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"-------#++++++++++++++#---------------------------------------------------------"$'\n'"------#++++++++++++++++#--------------------------------------------------------"$'\n'"-----#++++++++++++++++++###################################---------------------"$'\n'"-----#+++++++++++++++++++++++++++++++++++++++++++++++++++++#--------------------"$'\n'"-----#++++++++++++++++++#################+###+###+###+###++#--------------------"$'\n'"------#++++++++++++++++#----------------###-###-###-###-###---------------------"$'\n'"-------#++++++++++++++#---------------------------------------------------------"$'\n'"--------##############----------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'"--------------------------------------------------------------------------------"$'\n'$'\n'"155 pixels changed."

rm -f blank.txt image1.txt image2.txt

echo -e "\nTotal tests run: $total"
echo -e "Number correct : $num_right"
echo -n "Percent correct: "
echo "scale=2; 100 * $num_right / $total" | bc

if [ "$language" = "java" ]; then
   echo -e -n "\nRemoving class files..."
   rm -f *.class
   echo "done"
fi
